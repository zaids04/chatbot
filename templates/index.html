<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Waste Management Chatbot</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      /* Dark theme inspired by AI Studio */
      --bg-page: radial-gradient(1200px 800px at 70% -20%, rgba(88,101,242,.18), transparent 60%),
                  radial-gradient(1000px 700px at -10% 120%, rgba(0,170,255,.12), transparent 55%),
                  #0b0e13;
      --bg-elev-1: #0f141b;         /* surfaces */
      --bg-elev-2: #141b24;         /* subtle blocks */
      --bg-sidebar: #0f141b;        /* left nav */
      --bg-bubble-user: #2563eb;    /* user bubble */
      --bg-bubble-bot: #1f2937;     /* bot bubble */
      --text-strong: #e5e7eb;       /* headings */
      --text-body: #d1d5db;         /* main text */
      --text-muted: #9ca3af;        /* muted */
      --text-on-dark: #e5e7eb;      /* on dark */
      --accent: #475569;            /* neutral accent */
      --accent-strong: #94a3b8;
      --danger: #ef4444;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --shadow-1: 0 1px 2px rgba(0,0,0,.4);
      --shadow-2: 0 6px 24px rgba(0,0,0,.45);
    }

    * { box-sizing: border-box; }

    html, body { height: 100%; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-page);
      color: var(--text-body);
      margin: 0;
      line-height: 1.6;
    }

    /* App shell */
    .app {
      display: flex;
      height: 100vh;
      width: 100%;
      overflow: hidden;
    }

    /* Sidebar (roll-out) */
    .sidebar {
      width: 300px;
      background: var(--bg-sidebar);
      color: var(--text-on-dark);
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0; left: 0; height: 100vh;
      border-right: 0; /* borderless */
      box-shadow: inset -1px 0 0 rgba(255,255,255,.04);
    }
    .sidebar-header { padding: 18px 16px; font-weight: 600; display:flex; align-items:center; justify-content:space-between; }
    .sidebar-content { padding: 0 12px 16px; overflow: auto; }
    .sidebar .muted { color: #9ca3af; }

    .history-item {
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.07);
      border-radius: var(--radius-sm);
      padding: 12px;
      margin: 10px 0;
    }
    .history-item .meta { font-size: 12px; color: #9ca3af; display:flex; justify-content:space-between; margin-bottom:6px; }
    .history-item .sql { font-family:'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace; font-size:12px; color:#d1d5db; background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); padding:8px; border-radius:6px; max-height:80px; overflow:auto; }
    .history-actions { display:flex; gap:8px; margin-top:8px; }

    /* Sidebar toggle removed (fixed sidebar) */

    /* Main area */
    .main {
      position: relative;
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
      margin-left: 300px; /* account for fixed sidebar */
    }
    .topbar {
      height: 56px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 20px;
      color: var(--text-strong);
      border-bottom: 0;
      background: transparent;
      font-weight: 700;
      letter-spacing: -0.01em;
    }
    .topbar .title { text-align:center; flex: 1; }
    .topbar .actions { display:flex; gap:8px; }
    .main-title, .main-subtitle { position: static; opacity: 1; text-align: center; }
    .chat-scroll { padding: 24px 0 24px 0; }

    /* Main title with faster fade-in animation */
    .main-title {
      position:fixed;
      top: 180px;
      left: 59%;
      transform: translateX(-50%);
      font-size: 36px;
      font-weight: 800;
      color: #ffffff;
      text-align: center;
      z-index: 1000;
      opacity: 0;
      animation: simpleTitleAnimation 1s ease-out 0.3s forwards;
      letter-spacing: -0.02em;
    }

    /* Subtitle styling */
    .main-subtitle {
      position: fixed;
      top: 240px;
      left: 59%;
      transform: translateX(-50%);
      font-size: 16px;
      font-weight: 500;
      color: #ffffff;
      text-align: center;
      z-index: 1000;
      opacity: 0;
      animation: simpleSubtitleAnimation 1s ease-out 0.8s forwards;
      letter-spacing: 0.5px;
    }

    @keyframes simpleTitleAnimation {
      from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    @keyframes simpleSubtitleAnimation {
      from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    .chat-scroll {
      flex: 1 1 auto;
      overflow: auto;
      padding: 380px 0 24px 0; /* Add top padding to account for fixed search bar */
      transition: padding 0.5s ease-in-out;
    }

    /* Chat scroll when composer is at bottom */
    .composer.moved-to-bottom ~ .chat-scroll { padding: 24px 0; }
    .chat-inner {
      width: 100%;
      max-width: 980px;
      margin: 0 auto;
      padding: 0 20px;
    }


    /* Message bubbles */
    #log { border: none; height: auto; overflow: visible; padding: 0; background: transparent; margin: 0; }
    .msg { display:flex; gap:12px; margin: 10px 0; }
    .msg.user { justify-content: flex-end; }
    .msg.bot { justify-content: flex-start; }
    .msg .bubble { max-width: 80%; padding: 12px 14px; border-radius: var(--radius-md); box-shadow: var(--shadow-2); border: 1px solid rgba(255,255,255,.06); }
    .msg.user .bubble { background: #2563eb; color: #e5e7eb; border-color: transparent; }
    .msg.bot .bubble { background: #0b1220; color: #e5e7eb; }

    /* Result blocks under bubbles */
    .sql, .analysis{ background: var(--bg-elev-2); border:1px solid #e5e7eb; border-radius: var(--radius-sm); padding:12px; margin-top:12px; }
    .sql{ font-family:'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace; font-size:13px; line-height:1.5; }
    .analysis{ background:#eefbf2; border-color:#c7ebd3; }
    .error{ color: var(--danger); font-weight:600; }

    /* Table */
    table{ width:100%; border-collapse: collapse; margin-top:12px; border-radius: 10px; overflow:hidden; box-shadow: var(--shadow-2); }
    th,td{ border:1px solid rgba(255,255,255,.06); padding:10px; text-align:left; color: var(--text-body); }
    th{ background: #0b1220; font-weight:600; color: var(--text-strong); }

    /* Composer */
    .composer { border-top: none; background: transparent; position: fixed; top: 380px; left: 59%; transform: translateX(-50%); z-index: 1000; opacity: 1; transition: top 0.5s ease-in-out, position 0.5s ease-in-out, width 0.5s ease-in-out, margin-left 0.5s ease-in-out, background 0.5s ease-in-out, border-top 0.5s ease-in-out; }

    .composer.moved-to-bottom { position: sticky; bottom: 0; top: auto; left: auto; transform: none; width: 1300px; background: var(--bg-elev-1); border-top: 1px solid rgba(255,255,255,.06); box-sizing: border-box; }

    .composer-inner { max-width: none; width: 700px; margin: 0 auto; padding: 12px 20px; display:flex; gap: 10px; align-items: center; justify-content: center; }
    .composer.moved-to-bottom .composer-inner { max-width: 820px; background: var(--bg-elev-1); }

    .input-container { position: relative; flex: 1; display: flex; align-items: center; }

    input[type="text"]{ flex: 1; width: 100%; max-width: none; padding: 14px 50px 14px 16px; border: 2px solid rgba(255,255,255,0.8); border-radius: 999px; font-size: 14px; transition: border-color .15s ease, box-shadow .15s ease; background: #0b1220; color: var(--text-on-dark); }

    .send-icon { position: absolute; right: 16px; color: #ffffff; cursor: pointer; font-size: 24px; transition: color 0.2s ease, transform 0.2s ease; }
    .send-icon:hover { color: #94a3b8; transform: scale(1.1); }

    .composer.moved-to-bottom input[type="text"] { width: auto; border: 1px solid rgba(255,255,255,.06); }
    input[type="text"]:focus{ outline: none; border-color: rgba(255,255,255,1); box-shadow: 0 0 0 3px rgba(255,255,255,0.3); }

    button{ padding: 12px 16px; border: 1px solid rgba(255,255,255,.06); border-radius: 999px; background: #111827; color:#fff; cursor:pointer; font-weight: 600; font-size: 14px; transition: transform .2s ease, box-shadow .2s ease; }
    button:hover{ transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,.45); }
    .btn-secondary{ background: #1f2937; color:#e5e7eb; border-color: transparent; }
    .btn-danger{ background: #7f1d1d; color:#fff; border-color: transparent; }
    .btn-ghost{ background: var(--bg-elev-1); color: var(--text-body); }

    ::-webkit-scrollbar{ width:8px; height:8px; }
    ::-webkit-scrollbar-track{ background: #0b1220; }
    ::-webkit-scrollbar-thumb{ background: #374151; border-radius:4px; }
    ::-webkit-scrollbar-thumb:hover{ background: #4b5563; }

    @media (max-width: 1024px){ .sidebar{ width: 260px; } .main{ margin-left: 260px; } }

    /* Optional: tiny spinner for send icon when loading */
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .spin { animation: spin 1s linear infinite; }
  </style>
</head>
<body>
  <div class="app">
    <div id="sidebar" class="sidebar" aria-label="History sidebar">
      <div class="sidebar-header">
        <div>History</div>
        <div style="display:flex; gap:8px;">
          <button class="btn-ghost" onclick="newChat()">New Chat</button>
          <button class="btn-danger" onclick="clearHistory()">Clear</button>
        </div>
      </div>
      <div class="sidebar-content">
        <div id="historyList"></div>
        <div class="muted">Saved locally in your browser. Persists across refresh.</div>
      </div>
    </div>

    <div class="main">
      <div class="topbar">
        <div style="width:28px;"></div>
        <div class="title"></div>
        <div class="actions"></div>
      </div>

      <div class="chat-scroll">
        <div class="chat-inner">
          <div class="main-title">Waste Management Chatbot</div>
          <div class="main-subtitle">Ask about the Waste Database</div>


          <div id="log" aria-live="polite"></div>
          <div id="result"></div>
        </div>
      </div>

      <div class="composer">
        <div class="composer-inner">
          <div class="input-container">
            <input id="msg" type="text" placeholder="e.g., 'compare recycling rates', 'show all rows', 'explain the rows'" />
            <i class="material-icons send-icon" id="sendIcon" onclick="send()" style="display: none;">send</i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const log = document.getElementById('log');
    const result = document.getElementById('result');
    const input = document.getElementById('msg');
    const historyList = document.getElementById('historyList');


    // ----- Chat helpers -----
    function appendUser(text) {
      const html = `
        <div class="msg user">
          <div class="bubble">${escapeHtml(text)}</div>
        </div>`;
      log.insertAdjacentHTML('beforeend', html);
      log.parentElement.scrollTop = log.parentElement.scrollHeight;
    }
    function appendBot(text) {
      const html = `
        <div class="msg bot">
          <div class="bubble">${text}</div>
        </div>`;
      log.insertAdjacentHTML('beforeend', html);
      log.parentElement.scrollTop = log.parentElement.scrollHeight;
    }
    function escapeHtml(s) { return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    function setLoading(on){
      const icon = document.getElementById('sendIcon');
      if (!icon) return;
      icon.style.pointerEvents = on ? 'none' : 'auto';
      icon.style.opacity = on ? '0.6' : '1';
      icon.classList.toggle('spin', on);
    }

    // Change this if your API is on another origin
    const API_BASE = '';

    async function send() {
      const message = input.value.trim();
      if (!message) return;
      input.value = '';

      // Hide send icon after sending
      const sendIcon = document.getElementById('sendIcon');
      if (sendIcon) sendIcon.style.display = 'none';

      // Move composer to bottom when sending message
      const composer = document.querySelector('.composer');
      composer.classList.add('moved-to-bottom');

      appendUser(message);
      result.innerHTML = '';
      setLoading(true);

      try {
        const url = `${API_BASE}/chat`.replace(/^(https?:\/\/)?$/, '/chat');
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });

        if (!res.ok) {
          const txt = await res.text().catch(() => '');
          throw new Error(`HTTP ${res.status} ${res.statusText} — ${txt.slice(0,200)}`);
        }

        let data;
        try { data = await res.json(); }
        catch { throw new Error('Response was not valid JSON'); }

        if (!data.ok) {
          appendBot(`<span class="error">${escapeHtml(data.message || 'Error')}</span>`);
          if (data.sql) result.innerHTML = `<div class="sql"><b>SQL:</b> ${escapeHtml(data.sql)}</div>`;
          saveHistory({ ok:false, user: message, ts: data.ts || new Date().toISOString(), mode: data.mode || 'error', sql: data.sql || '', rows: [], columns: [], analysis: data.message || 'Error' });
          renderHistory();
          setLoading(false);
          return;
        }

        // Combine analysis + SQL + (optional) table into one bot bubble
        const parts = [];
        if (data.analysis) parts.push(`<div><b>Analysis:</b> ${escapeHtml(data.analysis)}</div>`);
        if (data.sql) parts.push(`<div style="margin-top:8px;"><b>SQL:</b> ${escapeHtml(data.sql)}</div>`);
        if (data.rows && data.rows.length) {
          const cols = (data.columns && data.columns.length) ? data.columns : Object.keys(data.rows[0]);
          const header = `<tr>` + cols.map(c => `<th>${escapeHtml(c)}</th>`).join('') + `</tr>`;
          const body = data.rows.slice(0, 10).map(r => `<tr>` + cols.map(c => `<td>${escapeHtml(String(r[c] ?? ''))}</td>`).join('') + `</tr>`).join('');
          parts.push(`<div style="margin-top:10px;"><table><thead>${header}</thead><tbody>${body}</tbody></table></div>`);
        }
        if (parts.length) appendBot(parts.join(''));

        // Save history with analysis
        addEntryToCurrent({ ok:true, user: message, ts: data.ts || new Date().toISOString(), mode: data.mode || '', sql: data.sql || '', rows: data.rows || [], columns: data.columns || [], analysis: data.analysis || '' });
        renderHistory();

      } catch (e) {
        appendBot(`<span class="error">${escapeHtml(e.message || 'Failed to contact server.')}</span>`);
        console.error(e);
      } finally {
        setLoading(false);
      }
    }

    // ----- History (localStorage) -----
    const KEY = 'wastechat_threads_v1';
    const CURRENT_ID_KEY = 'wastechat_current_thread_id';

    function loadThreads(){ try { return JSON.parse(localStorage.getItem(KEY) || '[]'); } catch { return []; } }
    function saveThreads(threads){ localStorage.setItem(KEY, JSON.stringify(threads)); }
    function getCurrentThreadId(){ return localStorage.getItem(CURRENT_ID_KEY); }
    function setCurrentThreadId(id){ localStorage.setItem(CURRENT_ID_KEY, id); }
    function createThread(){
      const id = Date.now().toString();
      const thread = { id, title: '', ts: new Date().toISOString(), entries: [] };
      const threads = loadThreads();
      threads.unshift(thread);
      saveThreads(threads.slice(0,50));
      setCurrentThreadId(id);
      return id;
    }
    function addEntryToCurrent(entry){
      let threads = loadThreads();
      let id = getCurrentThreadId();
      if (!id) { id = createThread(); threads = loadThreads(); }
      const idx = threads.findIndex(t => t.id === id);
      if (idx === -1) { id = createThread(); threads = loadThreads(); }
      if (!threads[idx].title && entry.user) { threads[idx].title = entry.user.slice(0,60); }
      threads[idx].entries.unshift(entry);
      saveThreads(threads);
    }
    function clearHistory(){ localStorage.removeItem(KEY); localStorage.removeItem(CURRENT_ID_KEY); renderHistory(); }
    function newChat(){
      createThread();
      log.innerHTML = '';
      result.innerHTML = '';
      input.value = '';
      log.parentElement.scrollTop = 0;
      const composer = document.querySelector('.composer');
      composer.classList.remove('moved-to-bottom');
      renderHistory();
    }

    function rerunIdx(i){ const e=(window.wasteHist||[])[i]; if(e){ input.value=e.user; send(); } }
    function previewIdx(i){ const e=(window.wasteHist||[])[i]; if(e) preview(e); }
    function loadThread(id){
      const threads = loadThreads();
      const thread = threads.find(t => t.id === id);
      if(!thread){ return; }
      setCurrentThreadId(id);
      const latest = thread.entries[0];
      if (latest) { preview(latest); }
    }

    function preview(entry){
      result.innerHTML = '';
      const parts = [];
      if (entry.analysis) parts.push(`<div><b>Analysis:</b> ${escapeHtml(entry.analysis)}</div>`);
      if (entry.sql) parts.push(`<div style=\"margin-top:8px;\"><b>SQL:</b> ${escapeHtml(entry.sql)}</div>`);
      if (entry.ok && entry.rows && entry.rows.length){
        const cols = entry.columns && entry.columns.length ? entry.columns : Object.keys(entry.rows[0]);
        const header = `<tr>` + cols.map(c => `<th>${escapeHtml(c)}</th>`).join("") + `</tr>`;
        const body = entry.rows.slice(0,10).map(r => `<tr>` + cols.map(c => `<td>${escapeHtml(String(r[c] ?? ''))}</td>`).join("") + `</tr>`).join("");
        parts.push(`<div style=\"margin-top:10px;\"><table><thead>${header}</thead><tbody>${body}</tbody></table></div>`);
      }
      if (parts.length) appendBot(parts.join(""));
    }

    function renderHistory(){
      const threads = loadThreads();
      historyList.innerHTML = '';
      if(!threads.length){
        historyList.innerHTML = `<div class="muted">No chats yet.</div>`;
        window.wasteHist = [];
        return;
      }
      window.wasteHist = threads.flatMap(t => t.entries);
      threads.forEach((t, idx) => {
        const title = t.title && t.title.trim() ? t.title : `Chat ${threads.length - idx}`;
        const div = document.createElement('div');
        div.className = 'history-item';
        div.style.cursor = 'pointer';
        div.innerHTML = `<div style="font-weight:600;">${escapeHtml(title)}</div>`;
        div.onclick = () => loadThread(t.id);
        historyList.appendChild(div);
      });
    }

    // Enter key support and show/hide send icon
    const sendIcon = document.getElementById('sendIcon');
    function toggleSendIcon() { if (input.value.trim().length > 0) { sendIcon.style.display = 'block'; } else { sendIcon.style.display = 'none'; } }
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter') send(); });
    input.addEventListener('input', toggleSendIcon);


    // Hide title and subtitle on scroll
    function handleScroll() {
      const title = document.querySelector('.main-title');
      const subtitle = document.querySelector('.main-subtitle');
      const windowScroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
      const chatScroll = document.querySelector('.chat-scroll');
      const chatScrollTop = chatScroll ? chatScroll.scrollTop : 0;
      const scrollTop = Math.max(windowScroll, chatScrollTop);
      if (scrollTop > 50) { title.style.display = 'none'; subtitle.style.display = 'none'; }
      else { title.style.display = 'block'; subtitle.style.display = 'block'; }
    }
    window.addEventListener('scroll', handleScroll);
    document.addEventListener('scroll', handleScroll);
    const chatScrollElement = document.querySelector('.chat-scroll');
    if (chatScrollElement) chatScrollElement.addEventListener('scroll', handleScroll);

    // Init
    renderHistory();
  </script>
</body>
</html>
